<div class="space-y-6">
  <!-- Header -->
  <div class="md:flex md:items-center md:justify-between">
    <div class="flex-1 min-w-0">
      <h2
        class="text-xl font-bold leading-7 text-gray-900 sm:text-xl sm:truncate"
      >
        Ranking Karyawan Terbaik
      </h2>
      <p class="mt-1 text-sm text-gray-500">
        Peringkat berdasarkan evaluasi 360Â° dengan perhitungan AHP
        <span *ngIf="activeWeights" class="ml-2 text-blue-600 font-medium">
          (Menggunakan: {{ activeWeights.name }})
        </span>
      </p>
    </div>
    <div class="mt-4 flex space-x-3 md:mt-0 md:ml-4">
      <select
        class="block px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 cursor-pointer"
      >
        <option value="2024-Q1">2024 - Q1</option>
        <option value="2023-Q4">2023 - Q4</option>
        <option value="2023-Q3">2023 - Q3</option>
      </select>
      <div class="flex rounded-md shadow-sm">
        <button
          (click)="viewMode = 'table'"
          [ngClass]="{ 'bg-blue-50 text-blue-700': viewMode === 'table' }"
          class="px-4 py-2 text-sm font-medium border border-gray-300 rounded-l-md cursor-pointer"
        >
          Tabel
        </button>
        <button
          (click)="viewMode = 'chart'"
          [ngClass]="{ 'bg-blue-50 text-blue-700': viewMode === 'chart' }"
          class="px-4 py-2 text-sm font-medium border-t border-b border-gray-300 cursor-pointer"
        >
          Grafik
        </button>
        <button
          (click)="viewMode = 'detailed'"
          [ngClass]="{ 'bg-blue-50 text-blue-700': viewMode === 'detailed' }"
          class="px-4 py-2 text-sm font-medium border border-gray-300 rounded-r-md cursor-pointer"
        >
          Detail
        </button>
      </div>
    </div>
  </div>

  <!-- AHP Weights Status Banner -->
  <div
    *ngIf="!activeWeights; else activeWeightsInfo"
    class="bg-yellow-50 border border-yellow-200 rounded-lg p-4"
  >
    <div class="flex items-center">
      <lucide-icon [img]="Settings" class="w-5 h-5 text-yellow-700" />
      <div class="ml-3">
        <h3 class="text-sm font-medium text-yellow-800">
          Bobot AHP Belum Dikonfigurasi
        </h3>
        <p class="mt-2 text-sm text-yellow-700">
          Ranking saat ini menggunakan bobot yang sama untuk semua kriteria.
          Untuk hasil lebih akurat, konfigurasikan AHP.
        </p>
        <div class="mt-3">
          <a
            href="/ahp"
            class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-yellow-800 bg-yellow-100 hover:bg-yellow-200"
          >
            <lucide-icon [img]="Calculator" class="w-4 h-4 mr-2" />
            Setup AHP
          </a>
        </div>
      </div>
    </div>
  </div>
  <ng-template #activeWeightsInfo>
    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
      <p class="text-sm text-green-800">
        Menggunakan Bobot AHP: <strong>{{ activeWeights?.name }}</strong> (CR:
        {{
          activeWeights?.consistencyRatio
            ? activeWeights?.consistencyRatio?.toFixed(3)
            : "N/A"
        }})
      </p>
    </div>
  </ng-template>

  <!-- Detailed View Employee Selector -->
  <div *ngIf="viewMode === 'detailed'" class="bg-white shadow rounded-lg p-4">
    <label for="employee-select" class="text-sm font-medium text-gray-700 mr-4"
      >Analisis Detail Karyawan:</label
    >
    <select
      id="employee-select"
      [ngModel]="selectedEmployeeId"
      (ngModelChange)="onEmployeeSelectionChange($event)"
      class="block w-full md:w-1/3 px-3 py-2 border border-gray-300 rounded-md"
    >
      <option value="">Pilih karyawan...</option>
      <option *ngFor="let score of employeeScores" [value]="score.employeeId">
        #{{ score.rank }} - {{ score.employee.name }} ({{
          score.totalScore.toFixed(2)
        }})
      </option>
    </select>
  </div>

  <!-- Top Performers (Not in Detailed View) -->
  <div *ngIf="viewMode !== 'detailed'" class="bg-white shadow rounded-lg p-6">
    <h3 class="text-lg font-medium text-gray-900 mb-6">Top 3 Performers</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div *ngFor="let performer of topPerformers" class="text-center">
        <div
          class="w-20 h-20 mx-auto rounded-full flex items-center justify-center mb-4 bg-gradient-to-br"
          [ngClass]="getRankBadgeClass(performer.rank)"
        >
          <div class="text-white text-2xl font-bold">#{{ performer.rank }}</div>
        </div>
        <h4 class="text-lg font-semibold text-gray-900">
          {{ performer.employee.name }}
        </h4>
        <p class="text-sm text-gray-500">{{ performer.employee.position }}</p>
        <p class="text-2xl font-bold text-blue-600">
          {{ performer.totalScore.toFixed(2) }}
        </p>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div [ngSwitch]="viewMode">
    <!-- Table View -->
    <ng-container *ngSwitchCase="'table'">
      <div class="bg-white shadow overflow-x-auto sm:rounded-md">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
          <div class="flex justify-between items-center">
            <h3 class="text-lg font-medium text-gray-900">
              Peringkat Lengkap - 2024 - Q1
            </h3>
          </div>
        </div>
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
              >
                Rank
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
              >
                Karyawan
              </th>
              <ng-container *ngFor="let criteria of evaluationCriteria">
                <th
                  class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  {{ criteria.code }}
                </th>
              </ng-container>
              <th
                class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase"
              >
                Total Score
              </th>
              <th
                class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase"
              >
                Normalized
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <tr *ngFor="let score of employeeScores" class="hover:bg-gray-50">
              <td class="px-6 py-4">
                <div class="flex items-center">
                  <span
                    class="inline-flex items-center justify-center w-8 h-8 rounded-full text-sm font-bold"
                    [ngClass]="getRankBadgeClass(score.rank)"
                  >
                    {{ score.rank }}
                  </span>
                  <div class="ml-2">
                    <lucide-icon
                      [img]="getRankIcon(score.rank)"
                      [ngClass]="getRankClass(score.rank)"
                    />
                  </div>
                </div>
              </td>
              <td class="px-6 py-4">
                <div class="flex items-center">
                  <div
                    class="h-10 w-10 rounded-full bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center"
                  >
                    <span class="text-white font-medium text-sm">
                      {{ initials(score.employee.name) }}
                    </span>
                  </div>
                  <div class="ml-4">
                    <div class="text-sm font-medium text-gray-900">
                      {{ score.employee.name }}
                    </div>
                    <div class="text-sm text-gray-500">
                      {{ score.employee.position }}
                    </div>
                  </div>
                </div>
              </td>
              <ng-container *ngFor="let criteria of evaluationCriteria">
                <td
                  class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-900"
                >
                  {{
                    getAverageScoreForCriteria(score, criteria.id)
                      | number : "1.0-1"
                  }}
                </td>
              </ng-container>
              <td class="px-6 py-4 text-center text-lg font-bold text-blue-600">
                {{ score.totalScore.toFixed(2) }}
              </td>
              <td
                class="px-6 py-4 text-center text-sm font-medium text-green-600"
              >
                {{ score.normalizedScore.toFixed(1) }}%
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </ng-container>

    <!-- Chart View -->
    <ng-container *ngSwitchCase="'chart'">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white shadow rounded-lg p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4">
            Top 10 Karyawan - Skor Total
          </h3>
          <div class="h-80">
            <ngx-charts-bar-vertical
              [results]="barChartData"
              [scheme]="barChartColorScheme"
              [xAxis]="true"
              [yAxis]="true"
              [legend]="false"
              [showGridLines]="true"
              [roundDomains]="true"
              [animations]="false"
              [yAxisTickFormatting]="formatScore"
            >
              <ng-template #tooltipTemplate let-model="model">
                <div
                  class="bg-white p-3 border border-gray-300 rounded-lg shadow-lg"
                >
                  <p class="font-medium">{{ model.name }}</p>
                  <p class="text-sm text-gray-600">
                    {{ model.extra.position }}
                  </p>
                  <p class="text-blue-600 font-bold">
                    Skor: {{ model.value | number : "1.2-2" }}
                  </p>
                </div>
              </ng-template>
            </ngx-charts-bar-vertical>
          </div>
        </div>
        <div class="bg-white shadow rounded-lg p-6">
          <h3 class="text-lg font-medium text-gray-900 mb-4">
            Distribusi Skor per Kriteria
          </h3>
          <div class="h-80">
            <ngx-charts-pie-chart
              [results]="pieChartData"
              [legend]="false"
              [labels]="true"
              [doughnut]="true"
              [animations]="false"
              [scheme]="pieChartColorScheme"
            >
            </ngx-charts-pie-chart>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- Detailed View -->
    <ng-container *ngSwitchCase="'detailed'">
      <div
        *ngIf="getSelectedEmployeeScore() as selectedScore; else noSelection"
        class="space-y-6"
      >
        <div class="bg-white shadow rounded-lg p-6">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <h4 class="text-md font-medium text-gray-900 mb-4">
                Profil Kompetensi
              </h4>
              <div class="h-80">
                <!-- <ngx-charts-polar-chart
                  [results]="radarChartData"
                  [xAxis]="true"
                  [yAxis]="true"
                  [legend]="false"
                  [scheme]="colorScheme"
                >
                </ngx-charts-polar-chart> -->
              </div>
            </div>
            <div>
              <h4 class="text-md font-medium text-gray-900 mb-4">
                Breakdown per Kriteria
              </h4>
              <div class="space-y-4">
                <div
                  *ngFor="let criteria of evaluationCriteria"
                  class="border border-gray-200 rounded-lg p-4"
                >
                  <div class="flex justify-between items-center">
                    <h5 class="font-medium text-gray-900">
                      {{ criteria.name }}
                    </h5>
                    <p class="text-lg font-bold text-blue-600">
                      {{
                        getAverageScoreForCriteria(
                          selectedScore,
                          criteria.id
                        ).toFixed(1)
                      }}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <ng-template #noSelection>
        <div class="text-center bg-white shadow rounded-lg p-8">
          <p>Pilih karyawan dari dropdown untuk melihat analisis detail.</p>
        </div>
      </ng-template>
    </ng-container>
  </div>
</div>
